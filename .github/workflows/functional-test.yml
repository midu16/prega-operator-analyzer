name: Functional Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: quay.io
  IMAGE_NAME: quay.io/midu/prega-operator-analyzer
  PREGA_INDEX: quay.io/prega/prega-operator-index:v4.21

jobs:
  functional-test:
    name: Functional Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Build binary
      run: |
        mkdir -p bin
        go build -o bin/prega-operator-analyzer ./cmd

    - name: Install opm and skopeo (for local testing)
      run: |
        # Install opm
        curl -L https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.17.21/opm-linux-4.17.21.tar.gz -o opm-linux-4.17.21.tar.gz
        tar xvf opm-linux-4.17.21.tar.gz
        sudo mv opm-rhel8 /usr/local/bin/opm
        sudo chmod +x /usr/local/bin/opm
        rm opm-linux-4.17.21.tar.gz
        
        # Install skopeo
        sudo apt-get update
        sudo apt-get install -y skopeo

    - name: Verify tool installations
      run: |
        opm version
        which opm
        skopeo --version
        which skopeo

    - name: Test basic functionality
      run: |
        # Test help command
        ./bin/prega-operator-analyzer --help
        
        # Test with verbose output using test index file
        ./bin/prega-operator-analyzer --index-file=testdata/sample_index.json --verbose --output=test-release-notes.txt
        
        # Verify output file was created
        if [ ! -f "test-release-notes.txt" ]; then
          echo "ERROR: Output file was not created"
          exit 1
        fi
        
        # Check if output file has content
        if [ ! -s "test-release-notes.txt" ]; then
          echo "ERROR: Output file is empty"
          exit 1
        fi
        
        echo "✅ Output file created successfully with content"
        echo "File size: $(wc -l < test-release-notes.txt) lines"

    - name: Test cleanup functionality
      run: |
        # Verify prega-operator-index directory was cleaned up
        if [ -d "prega-operator-index" ]; then
          echo "❌ ERROR: prega-operator-index directory was not cleaned up"
          ls -la prega-operator-index/
          exit 1
        else
          echo "✅ SUCCESS: prega-operator-index directory was properly cleaned up"
        fi
        
        # Verify temp-repos directory was cleaned up
        if [ -d "temp-repos" ]; then
          echo "❌ ERROR: temp-repos directory was not cleaned up"
          ls -la temp-repos/
          exit 1
        else
          echo "✅ SUCCESS: temp-repos directory was properly cleaned up"
        fi

    - name: Test environment variable support
      run: |
        # Test with environment variables (OUTPUT_DIR)
        export OUTPUT_DIR="."
        
        ./bin/prega-operator-analyzer --index-file=testdata/sample_index.json --output=env-test-release-notes.txt --verbose
        
        # Verify output file was created
        if [ ! -f "env-test-release-notes.txt" ]; then
          echo "ERROR: Environment variable output file was not created"
          exit 1
        fi
        
        echo "✅ Environment variable test passed"

    - name: Test cleanup with environment variables
      run: |
        # Verify cleanup still works with environment variables
        if [ -d "prega-operator-index" ]; then
          echo "❌ ERROR: prega-operator-index directory was not cleaned up after env var test"
          exit 1
        else
          echo "✅ SUCCESS: Cleanup works with environment variables"
        fi

    - name: Test fallback behavior
      run: |
        # Test with different index file path
        echo "Testing with index file path..."
        ./bin/prega-operator-analyzer --index-file=testdata/sample_index.json --verbose --output=fallback-test.txt
        
        # Verify output file was created
        if [ ! -f "fallback-test.txt" ]; then
          echo "❌ ERROR: Output file was not created"
          exit 1
        fi
        
        # Check if output file has content
        if [ ! -s "fallback-test.txt" ]; then
          echo "❌ ERROR: Output file is empty"
          exit 1
        fi
        
        echo "✅ SUCCESS: Works with index file"
        echo "Output file size: $(wc -l < fallback-test.txt) lines"
        
        # Verify cleanup still happens (no prega-operator-index dir should be created when using index-file)
        if [ -d "prega-operator-index" ]; then
          echo "⚠️  WARNING: prega-operator-index directory exists (expected when using index-file)"
        else
          echo "✅ SUCCESS: No prega-operator-index directory created (expected when using index-file)"
        fi

    - name: Test environment variable fallback
      run: |
        # Test with INDEX_FILE environment variable
        export INDEX_FILE="testdata/sample_index.json"
        echo "Testing with INDEX_FILE environment variable: $INDEX_FILE..."
        
        ./bin/prega-operator-analyzer --verbose --output=env-fallback-test.txt
        
        # Verify output file was created
        if [ ! -f "env-fallback-test.txt" ]; then
          echo "❌ ERROR: Environment variable test did not work"
          exit 1
        fi
        
        echo "✅ SUCCESS: Environment variable works correctly"
        
        # Clean up for next test
        unset INDEX_FILE

    - name: Test dynamic tag fetching
      run: |
        # Test with index file (skip image pulling for reliable tests)
        echo "Testing with index file..."
        
        # Use index file to avoid image pulling issues
        ./bin/prega-operator-analyzer --index-file=testdata/sample_index.json --verbose --output=dynamic-tag-test.txt
        
        # Verify it worked
        if [ -f "dynamic-tag-test.txt" ] && [ -s "dynamic-tag-test.txt" ]; then
          echo "✅ SUCCESS: Index file test works"
          echo "Output file size: $(wc -l < dynamic-tag-test.txt) lines"
        else
          echo "❌ ERROR: Index file test failed"
          exit 1
        fi

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: functional-test-results
        path: |
          test-release-notes.txt
          env-test-release-notes.txt
          fallback-test.txt
          env-fallback-test.txt
          dynamic-tag-test.txt
        retention-days: 7

    - name: Test summary
      run: |
        echo "## Functional Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All functional tests passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Coverage:" >> $GITHUB_STEP_SUMMARY
        echo "- Basic functionality test (using test index file)" >> $GITHUB_STEP_SUMMARY
        echo "- Cleanup functionality test" >> $GITHUB_STEP_SUMMARY
        echo "- Environment variable support test" >> $GITHUB_STEP_SUMMARY
        echo "- Index file path test" >> $GITHUB_STEP_SUMMARY
        echo "- Environment variable with index file test" >> $GITHUB_STEP_SUMMARY
        echo "- Index file test" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- test-release-notes.txt: $(wc -l < test-release-notes.txt) lines" >> $GITHUB_STEP_SUMMARY
        echo "- env-test-release-notes.txt: $(wc -l < env-test-release-notes.txt) lines" >> $GITHUB_STEP_SUMMARY
        echo "- fallback-test.txt: $(wc -l < fallback-test.txt) lines" >> $GITHUB_STEP_SUMMARY
        echo "- env-fallback-test.txt: $(wc -l < env-fallback-test.txt) lines" >> $GITHUB_STEP_SUMMARY
        echo "- dynamic-tag-test.txt: $(wc -l < dynamic-tag-test.txt) lines" >> $GITHUB_STEP_SUMMARY
